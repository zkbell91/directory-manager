{% extends "base.html" %}

{% block title %}Profiles - Directory Manager{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">Profiles</li>
        {% if therapist_filter %}
        <li class="breadcrumb-item active">{{ therapist_filter }}</li>
        {% endif %}
    </ol>
</nav>

<!-- Header with Filters -->
<div class="d-flex justify-content-between align-items-center mb-5">
    <div>
        <h1 class="h2 mb-2 fw-bold text-primary">
            <i class="fas fa-id-card me-2"></i>Profiles
            {% if therapist_filter %}
            <span class="badge bg-secondary ms-2">{{ therapist_filter }}</span>
            {% endif %}
            {% if directory_filter %}
            <span class="badge bg-info ms-2">{{ directory_filter }}</span>
            {% endif %}
        </h1>
        {% if therapist_filter or directory_filter %}
        <p class="text-muted mb-0 fs-5">Filtered view - {{ profiles|length }} profile(s) found</p>
        {% else %}
        <p class="text-muted mb-0 fs-5">Manage therapist directory profiles across all platforms</p>
        {% endif %}
    </div>
    <div>
        <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addProfileModal">
            <i class="fas fa-plus me-2"></i>Add Profile
        </button>
    </div>
</div>

<!-- Smart Filters -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <label for="therapistFilter" class="form-label">Filter by Therapist</label>
                <select class="form-select filter-dropdown" id="therapistFilter">
                    <option value="">All Therapists</option>
                    {% for therapist in therapists %}
                    <option value="{{ therapist.name }}" {% if therapist_filter == therapist.name %}selected{% endif %}>
                        {{ therapist.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="directoryFilter" class="form-label">Filter by Directory</label>
                <select class="form-select filter-dropdown" id="directoryFilter">
                    <option value="">All Directories</option>
                    {% for directory in directories %}
                    <option value="{{ directory.name }}" {% if directory_filter == directory.name %}selected{% endif %}>
                        {{ directory.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="statusFilter" class="form-label">Filter by Status</label>
                <select class="form-select filter-dropdown" id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="active">Active</option>
                    <option value="exists_unmanaged">Exists (Unmanaged)</option>
                    <option value="needs_claiming">Needs Claiming</option>
            <option value="incorrect_match">Incorrect Match</option>
            <option value="blocked">Search Blocked</option>
            <option value="not_found">Not Found</option>
            <option value="pending">Pending</option>
                    <option value="inactive">Inactive</option>
                    <option value="error">Error</option>
                </select>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <button class="btn btn-outline-secondary" onclick="clearFilters()">
                    <i class="fas fa-times me-2"></i>Clear Filters
                </button>
                <button class="btn btn-outline-primary" onclick="applyFilters()">
                    <i class="fas fa-filter me-2"></i>Apply Filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Profiles Grid -->
{% if profiles %}
<div class="row" id="profilesGrid">
    {% for profile in profiles %}
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card profile-card h-100" onclick="viewProfileDetails({{ profile.id }})" style="cursor: pointer;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">{{ profile.therapist_name }}</h6>
                <div class="dropdown" onclick="event.stopPropagation();">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="viewProfile({{ profile.id }})">
                            <i class="fas fa-eye me-2"></i>View
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="editProfile({{ profile.id }})">
                            <i class="fas fa-edit me-2"></i>Edit
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="updateProfile({{ profile.id }})">
                            <i class="fas fa-sync me-2"></i>Update
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteProfile({{ profile.id }})">
                            <i class="fas fa-trash me-2"></i>Delete
                        </a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body">
                <div class="profile-status mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-globe me-2 text-primary"></i>
                        <strong>{{ profile.directory_name }}</strong>
                    </div>
                    <div class="d-flex align-items-center mb-2">
        <span class="badge bg-{{ 'success' if profile.status == 'active' else 'warning' if profile.status == 'pending' else 'info' if profile.status == 'needs_claiming' else 'secondary' if profile.status == 'exists_unmanaged' else 'danger' if profile.status in ['not_found', 'error', 'incorrect_match', 'blocked'] else 'secondary' }}">
            {{ profile.status.replace('_', ' ').title() }}
        </span>
                        {% if profile.ranking_position %}
                        <span class="badge bg-info ms-2">Rank #{{ profile.ranking_position }}</span>
                        {% endif %}
                    </div>
                </div>
                
                {% if profile.profile_url %}
                <div class="mb-3">
                    <a href="{{ profile.profile_url }}" target="_blank" class="btn btn-outline-primary btn-sm w-100">
                        <i class="fas fa-external-link-alt me-2"></i>View Profile
                    </a>
                </div>
                {% endif %}
                
                <div class="profile-stats">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="stat-item">
                                <div class="stat-number">{{ profile.profile_views or 0 }}</div>
                                <div class="stat-label">Views</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-item">
                                <div class="stat-number">{{ profile.contact_requests or 0 }}</div>
                                <div class="stat-label">Contacts</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-item">
                                <div class="stat-number">{{ profile.last_updated[:10] if profile.last_updated else 'N/A' }}</div>
                                <div class="stat-label">Updated</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <small class="text-muted">
                    <i class="fas fa-clock me-1"></i>
                    Last checked: {{ profile.last_checked[:10] if profile.last_checked else 'Never' }}
                </small>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
<div class="d-flex justify-content-center">
    <nav aria-label="Profiles pagination">
        <ul class="pagination">
            <li class="page-item disabled">
                <span class="page-link">Previous</span>
            </li>
            <li class="page-item active">
                <span class="page-link">1</span>
            </li>
            <li class="page-item">
                <a class="page-link" href="#">2</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="#">3</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="#">Next</a>
            </li>
        </ul>
    </nav>
</div>

{% else %}
<!-- Empty State -->
<div class="text-center py-5">
    <div class="empty-state">
        <i class="fas fa-id-card fa-4x text-muted mb-4"></i>
        <h4 class="text-muted">No Profiles Found</h4>
        <p class="text-muted mb-4">
            {% if therapist_filter or directory_filter %}
            No profiles match your current filters. Try adjusting your search criteria.
            {% else %}
            Get started by adding your first profile or importing data from your spreadsheets.
            {% endif %}
        </p>
        <div class="d-flex justify-content-center gap-3">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProfileModal">
                <i class="fas fa-plus me-2"></i>Add Profile
            </button>
            {% if therapist_filter or directory_filter %}
            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                <i class="fas fa-times me-2"></i>Clear Filters
            </button>
            {% endif %}
            <a href="{{ url_for('import_export') }}" class="btn btn-outline-info">
                <i class="fas fa-file-import me-2"></i>Import Data
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Add Profile Modal -->
<div class="modal fade" id="addProfileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2"></i>Add New Profile
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addProfileForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="profileTherapist" class="form-label">Therapist</label>
                            <select class="form-select" id="profileTherapist" required>
                                <option value="">Select Therapist</option>
                                {% for therapist in therapists %}
                                <option value="{{ therapist.id }}">{{ therapist.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="profileDirectory" class="form-label">Directory</label>
                            <select class="form-select" id="profileDirectory" required>
                                <option value="">Select Directory</option>
                                {% for directory in directories %}
                                <option value="{{ directory.id }}">{{ directory.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="profileUrl" class="form-label">Profile URL</label>
                        <input type="url" class="form-control" id="profileUrl" placeholder="https://...">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="profileUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="profileUsername">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="profilePassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="profilePassword">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="profileNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="profileNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProfile()">Create Profile</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Profile
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editProfileTherapist" class="form-label">Therapist</label>
                            <select class="form-select" id="editProfileTherapist" required>
                                <option value="">Select Therapist</option>
                                {% for therapist in therapists %}
                                <option value="{{ therapist.id }}">{{ therapist.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editProfileDirectory" class="form-label">Directory</label>
                            <select class="form-select" id="editProfileDirectory" required>
                                <option value="">Select Directory</option>
                                {% for directory in directories %}
                                <option value="{{ directory.id }}">{{ directory.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editProfileUrl" class="form-label">Profile URL</label>
                        <input type="url" class="form-control" id="editProfileUrl">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editProfileUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="editProfileUsername">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editProfilePassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="editProfilePassword">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editProfileNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="editProfileNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateProfile()">Update Profile</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.profile-card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.profile-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    border-color: #007bff;
}

.profile-status {
    position: relative;
    overflow: hidden;
}

.profile-status::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: left 0.5s;
}

.profile-card:hover .profile-status::before {
    left: 100%;
}

.stat-item {
    padding: 0.5rem;
}

.stat-number {
    font-size: 1.2rem;
    font-weight: bold;
    color: #007bff;
}

.stat-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.empty-state {
    max-width: 400px;
    margin: 0 auto;
}

.breadcrumb-item {
    transition: all 0.3s ease;
}

.breadcrumb-item:hover {
    transform: translateX(5px);
}

.filter-dropdown {
    transition: all 0.3s ease;
}

.filter-dropdown:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-apply filters when dropdowns change
    document.getElementById('therapistFilter').addEventListener('change', applyFilters);
    document.getElementById('directoryFilter').addEventListener('change', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    
    // Add smooth animations to profile cards
    const profileCards = document.querySelectorAll('.profile-card');
    profileCards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('animate-in');
    });
});

function applyFilters() {
    const therapist = document.getElementById('therapistFilter').value;
    const directory = document.getElementById('directoryFilter').value;
    const status = document.getElementById('statusFilter').value;
    
    const params = new URLSearchParams();
    if (therapist) params.append('therapist', therapist);
    if (directory) params.append('directory', directory);
    if (status) params.append('status', status);
    
    const url = params.toString() ? `/profiles?${params.toString()}` : '/profiles';
    window.location.href = url;
}

function clearFilters() {
    window.location.href = '/profiles';
}

function viewProfile(id) {
    // Fetch and display profile details
    fetch(`/api/profile/${id}`)
        .then(response => response.json())
        .then(profile => {
            // Create a beautiful profile view modal
            showProfileViewModal(profile);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading profile data');
        });
}

function editProfile(id) {
    // Fetch profile data and populate edit form
    fetch(`/api/profile/${id}`)
        .then(response => response.json())
        .then(profile => {
            document.getElementById('editProfileTherapist').value = profile.therapist_id;
            document.getElementById('editProfileDirectory').value = profile.directory_id;
            document.getElementById('editProfileUrl').value = profile.profile_url || '';
            document.getElementById('editProfileUsername').value = profile.username || '';
            document.getElementById('editProfilePassword').value = profile.password || '';
            document.getElementById('editProfileNotes').value = profile.notes || '';
            
            // Store the profile ID in the modal
            document.getElementById('editProfileModal').setAttribute('data-profile-id', id);
            
            const editModal = new bootstrap.Modal(document.getElementById('editProfileModal'));
            editModal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading profile data');
        });
}

function deleteProfile(id) {
    if (confirm('Are you sure you want to delete this profile?')) {
        fetch(`/api/profile/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                alert('Profile deleted successfully');
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting profile');
        });
    }
}

function saveProfile() {
    const formData = {
        therapist_id: parseInt(document.getElementById('profileTherapist').value),
        directory_id: parseInt(document.getElementById('profileDirectory').value),
        profile_url: document.getElementById('profileUrl').value,
        username: document.getElementById('profileUsername').value,
        password: document.getElementById('profilePassword').value,
        notes: document.getElementById('profileNotes').value
    };
    
    fetch('/api/profile', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert('Profile created successfully');
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating profile');
    });
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('addProfileModal'));
    modal.hide();
}

function updateProfile() {
    // Get the profile ID from the modal data attribute
    const modal = document.getElementById('editProfileModal');
    const profileId = modal.getAttribute('data-profile-id');
    
    const formData = {
        therapist_id: parseInt(document.getElementById('editProfileTherapist').value),
        directory_id: parseInt(document.getElementById('editProfileDirectory').value),
        profile_url: document.getElementById('editProfileUrl').value,
        username: document.getElementById('editProfileUsername').value,
        password: document.getElementById('editProfilePassword').value,
        notes: document.getElementById('editProfileNotes').value
    };
    
    fetch(`/api/profile/${profileId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert('Profile updated successfully');
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating profile');
    });
    
    const modalInstance = bootstrap.Modal.getInstance(modal);
    modalInstance.hide();
}

function showProfileViewModal(profile) {
    const modalHtml = `
        <div class="modal fade" id="profileViewModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-light text-dark">
                        <h5 class="modal-title">
                            <i class="fas fa-id-card me-2"></i>Profile Details
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-muted">Therapist</h6>
                                <p class="fw-bold">${profile.therapist_name}</p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted">Directory</h6>
                                <p class="fw-bold">${profile.directory_name}</p>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-muted">Status</h6>
                                <span class="badge bg-${profile.status === 'active' ? 'success' : profile.status === 'pending' ? 'warning' : profile.status === 'needs_claiming' ? 'info' : profile.status === 'exists_unmanaged' ? 'secondary' : profile.status === 'not_found' || profile.status === 'error' || profile.status === 'incorrect_match' || profile.status === 'blocked' ? 'danger' : 'secondary'}">${profile.status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted">Ranking Position</h6>
                                <p>${profile.ranking_position || 'N/A'}</p>
                            </div>
                        </div>
                        ${profile.profile_url ? `
                        <div class="mt-3">
                            <a href="${profile.profile_url}" target="_blank" class="btn btn-outline-primary">
                                <i class="fas fa-external-link-alt me-2"></i>View Profile
                            </a>
                        </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('profileViewModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('profileViewModal'));
    modal.show();
}

function viewProfileDetails(profileId) {
    // Navigate to profile viewer page
    window.location.href = `/profile/${profileId}`;
}
</script>
{% endblock %}